name: PR Issue Link Sync

on:
  push:
    branches-ignore:
      - main
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  issues: read
  pull-requests: write

jobs:
  sync-issue-links:
    name: Sync Issue Links From Commit Messages
    runs-on: ubuntu-latest
    steps:
      - name: Sync PR Issue Link section
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            const normalizeKeyword = (raw) => {
              const keyword = raw.toLowerCase().replace(/\s+/g, " ");
              if (/^(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)$/.test(keyword)) {
                return "close";
              }
              return "ref";
            };

            const mergeAction = (current, next) => {
              if (current === "close" || next === "close") return "close";
              return "ref";
            };

            const KEYWORD_REF_RE = /\b(close[sd]?|fix(?:e[sd])?|resolve[sd]?|ref(?:erences?)?|see|part\s+of)\s*:?\s*#(\d+)\b/gim;
            const BARE_REF_RE = /(?<![&\w#])#(\d+)\b/g;

            const findOpenPrForBranch = async (branch) => {
              const { data } = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                head: `${owner}:${branch}`,
                per_page: 10,
              });
              return data[0] ?? null;
            };

            let pr = null;
            if (context.eventName === "pull_request") {
              pr = context.payload.pull_request ?? null;
            } else {
              const branch = context.ref.replace("refs/heads/", "");
              pr = await findOpenPrForBranch(branch);
            }

            if (!pr) {
              console.log("No open PR found for this branch/event. Nothing to update.");
              return;
            }

            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });

            if (commits.length === 0) {
              console.log(`PR #${pr.number} has no commits. Nothing to update.`);
              return;
            }

            const referenced = new Map();

            for (const commit of commits) {
              const message = commit.commit?.message ?? "";

              for (const match of message.matchAll(KEYWORD_REF_RE)) {
                const keyword = match[1];
                const issueNumber = Number(match[2]);
                const action = normalizeKeyword(keyword);
                referenced.set(issueNumber, mergeAction(referenced.get(issueNumber), action));
              }

              for (const match of message.matchAll(BARE_REF_RE)) {
                const issueNumber = Number(match[1]);
                if (!referenced.has(issueNumber)) {
                  referenced.set(issueNumber, "ref");
                }
              }
            }

            const validIssueLinks = new Map();
            for (const [issueNumber, action] of referenced.entries()) {
              try {
                const { data: issue } = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: issueNumber,
                });
                if (!issue.pull_request) {
                  validIssueLinks.set(issueNumber, action);
                }
              } catch (error) {
                console.log(`Skipping #${issueNumber}: not a repo issue (${error.message}).`);
              }
            }

            const sorted = [...validIssueLinks.entries()].sort((a, b) => a[0] - b[0]);
            const closes = sorted.filter(([, action]) => action === "close").map(([n]) => `Closes #${n}`);
            const refs = sorted.filter(([, action]) => action !== "close").map(([n]) => `Refs #${n}`);

            const autoStart = "<!-- issue-link-sync:start -->";
            const autoEnd = "<!-- issue-link-sync:end -->";
            const issueLines = [...closes, ...refs];
            const sectionBody = issueLines.length > 0
              ? `${autoStart}\n${issueLines.join("\n")}\n${autoEnd}`
              : `${autoStart}\nNo linked issues detected from commit messages.\n${autoEnd}`;

            const nextSection = `## Issue Link\n${sectionBody}\n`;
            const currentBody = (pr.body ?? "").trimEnd();
            const issueSectionRe = /##\s*Issue Link\s*\n[\s\S]*?(?=\n##\s+|$)/i;

            const nextBody = issueSectionRe.test(currentBody)
              ? currentBody.replace(issueSectionRe, nextSection.trimEnd())
              : `${currentBody}\n\n${nextSection}`;

            if (nextBody === currentBody) {
              console.log(`PR #${pr.number} issue links already up to date.`);
              return;
            }

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: pr.number,
              body: nextBody,
            });

            console.log(`Updated PR #${pr.number} Issue Link section.`);
