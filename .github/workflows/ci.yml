name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  quality:
    name: Lint, Typecheck, Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: |
          bun install --save-text-lockfile
          git diff --exit-code -- bun.lock

      - name: Lint
        run: bun run lint

      - name: Typecheck
        run: bun run typecheck:pkg

      - name: Test with coverage thresholds
        run: bun run test:coverage

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-reports
          path: |
            coverage/**
            packages/*/coverage/**
          if-no-files-found: warn

  loc-policy:
    name: LOC Policy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      LOC_CHECK_MODE: warn

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: |
          bun install --save-text-lockfile
          git diff --exit-code -- bun.lock

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install tokei
        run: cargo install tokei --locked --version 12.1.2

      - name: Run LOC policy check
        id: loc_check
        continue-on-error: true
        run: |
          set -o pipefail
          bun run loc:check:baseline 2>&1 | tee loc-check.txt

      - name: Upload LOC report artifact
        if: always() && hashFiles('loc-check.txt') != ''
        uses: actions/upload-artifact@v6
        with:
          name: loc-report
          path: loc-check.txt
          if-no-files-found: warn

      - name: Add LOC report to step summary
        if: always() && hashFiles('loc-check.txt') != ''
        run: |
          {
            echo "### LOC policy report"
            echo ""
            echo '```text'
            cat loc-check.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment LOC report on PR
        if: github.event_name == 'pull_request' && hashFiles('loc-check.txt') != ''
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require("node:fs");
            const marker = "<!-- loc-policy-report -->";
            const raw = fs.readFileSync("loc-check.txt", "utf8");
            const body = `${marker}\n## LOC policy report\n\n\`\`\`text\n${raw}\n\`\`\``;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });
            const existing = comments.data.find((comment) =>
              comment.body?.includes(marker),
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

      - name: Warn on LOC regressions
        if: steps.loc_check.outcome == 'failure' && env.LOC_CHECK_MODE != 'enforce'
        run: echo "::warning::LOC policy regressions detected (warn mode)."

      - name: Enforce LOC gate
        if: steps.loc_check.outcome == 'failure' && env.LOC_CHECK_MODE == 'enforce'
        run: |
          echo "LOC policy regressions detected (enforce mode)."
          exit 1

  docs:
    name: Docs Generate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: |
          bun install --save-text-lockfile
          git diff --exit-code -- bun.lock

      - name: Generate API docs
        run: bun run docs:api

      - name: Sync engineering docs
        run: bun run docs:sync

      - name: Upload generated docs artifact
        uses: actions/upload-artifact@v6
        with:
          name: docs-generated
          path: apps/docs/docs
          if-no-files-found: error
