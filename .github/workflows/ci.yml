name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  quality:
    name: Lint, Typecheck, Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: |
          bun install --save-text-lockfile
          git diff --exit-code -- bun.lock

      - name: Lint
        run: bun run lint

      - name: Typecheck
        run: bun run typecheck:pkg

      - name: Facade compatibility policy checks
        run: bun run facade:compat

      - name: Golden governance checks
        run: bun run golden:governance

      - name: Determinism conformance checks
        run: bun run conformance:determinism

      - name: Marketplace control-plane conformance checks
        run: bun run conformance:marketplace:control-plane

      - name: Tiered conformance smoke gate
        run: bun run conformance:tier:smoke

      - name: Test with coverage thresholds
        id: test_coverage
        continue-on-error: true
        run: |
          bun run test:coverage 2>&1 | tee coverage-report.txt

      - name: Setup Python for Semgrep
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Semgrep
        run: python -m pip install --upgrade semgrep

      - name: Run Semgrep
        id: semgrep
        continue-on-error: true
        run: semgrep --config auto --sarif --output semgrep-results.sarif --error

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-reports
          path: |
            coverage/**
            packages/*/coverage/**
            products/*/*/coverage/**
          if-no-files-found: warn

      - name: Upload Semgrep SARIF
        if: >-
          always() &&
          hashFiles('semgrep-results.sarif') != '' &&
          (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep-results.sarif

      - name: Add CI summary
        if: always()
        run: |
          {
            echo "## CI Summary"
            echo ""
            echo "### Test coverage report"
            echo ""
            echo '```text'
            if [ -f coverage-report.txt ]; then
              cat coverage-report.txt
            else
              echo "Coverage report was not generated."
            fi
            echo '```'
            echo ""
            echo "### Semgrep summary"
            echo ""
            node --input-type=module -e 'import { existsSync, readFileSync } from "node:fs"; if (!existsSync("semgrep-results.sarif")) { console.log("Semgrep report was not generated."); process.exit(0); } try { const data = JSON.parse(readFileSync("semgrep-results.sarif", "utf8")); const results = data.runs?.[0]?.results ?? []; if (results.length === 0) { console.log("No Semgrep findings."); process.exit(0); } const byRule = new Map(); for (const result of results) { const key = result.ruleId || "unknown"; byRule.set(key, (byRule.get(key) ?? 0) + 1); } console.log(`Findings: ${results.length}`); console.log(""); console.log("Findings by rule:"); for (const [rule, count] of [...byRule.entries()].sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))) { console.log(`- ${rule}: ${count}`); } } catch (error) { console.log(`Unable to parse semgrep report: ${error}`); }'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Enforce quality gates
        if: always()
        run: |
          if [ "${{ steps.test_coverage.outcome }}" = "failure" ]; then
            echo "::error::Tests with coverage failed."
            exit 1
          fi
          if [ "${{ steps.semgrep.outcome }}" = "failure" ]; then
            echo "::error::Semgrep found issues."
            exit 1
          fi

  docs:
    name: Docs Generate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: |
          bun install --save-text-lockfile
          git diff --exit-code -- bun.lock

      - name: Generate API docs
        run: bun run docs:api

      - name: Sync engineering docs
        run: bun run docs:sync

      - name: Upload generated docs artifact
        uses: actions/upload-artifact@v6
        with:
          name: docs-generated
          path: apps/docs/docs
          if-no-files-found: error
