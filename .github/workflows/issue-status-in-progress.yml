name: Issue Status - In Progress

on:
  push:
    branches-ignore:
      - main

permissions:
  issues: write
  contents: read

jobs:
  update-issue-status:
    name: Mark Referenced Issues as In Progress
    runs-on: ubuntu-latest
    steps:
      - name: Update referenced issues
        uses: actions/github-script@v7
        with:
          # Use GH_TOKEN (with project scope) when available, fall back to GITHUB_TOKEN.
          # Set the GH_TOKEN repo secret with 'project' read/write scope to also update
          # GitHub Projects v2 status fields.
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const commits = context.payload.commits ?? [];
            const branch = context.ref.replace("refs/heads/", "");

            // Match GitHub-style issue references in commit messages.
            // Captures keyword-prefixed refs (fixes/closes/resolves/ref/re/see/part of)
            // and bare #N references, while avoiding false matches like hex colours.
            const REF_RE =
              /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?|ref(?:erences?)?|re|see|part\s+of)\s*:?\s*#(\d+)|(?<![&\w#])#(\d+)/gim;

            const issueNumbers = new Set();
            for (const { message = "" } of commits) {
              for (const match of message.matchAll(REF_RE)) {
                const n = match[1] ?? match[2];
                if (n) issueNumbers.add(Number(n));
              }
            }

            if (!issueNumbers.size) {
              console.log(`No issue references found in push to "${branch}".`);
              return;
            }

            console.log(`Branch: ${branch}`);
            console.log(`Referenced issues: #${[...issueNumbers].join(", #")}`);

            const { owner, repo } = context.repo;

            // ── Label approach (works with the default GITHUB_TOKEN) ──────────────

            const LABEL = "in progress";

            // Ensure the label exists in this repo.
            try {
              await github.rest.issues.getLabel({ owner, repo, name: LABEL });
            } catch (err) {
              if (err.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: LABEL,
                  color: "fbca04",
                  description: "Work on this issue is currently in progress",
                });
                console.log(`Created label "${LABEL}"`);
              } else {
                throw err;
              }
            }

            for (const num of issueNumbers) {
              try {
                const { data: issue } = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: num,
                });

                if (issue.pull_request) {
                  console.log(`Skipping #${num}: is a pull request`);
                  continue;
                }
                if (issue.state === "closed") {
                  console.log(`Skipping #${num}: issue is already closed`);
                  continue;
                }

                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: num,
                  labels: [LABEL],
                });
                console.log(`✓ Labeled issue #${num} as "${LABEL}": ${issue.title}`);
              } catch (err) {
                if (err.status === 404) {
                  console.log(`Skipping #${num}: issue not found`);
                } else {
                  core.warning(`Could not update issue #${num}: ${err.message}`);
                }
              }
            }

            // ── GitHub Projects v2 approach ───────────────────────────────────────
            // Requires a GH_TOKEN secret with 'project' read/write scope.
            // If the token lacks project permissions this block is skipped silently.

            for (const num of issueNumbers) {
              let projectItems;
              try {
                const result = await github.graphql(
                  `query ($owner: String!, $repo: String!, $num: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $num) {
                        projectItems(first: 10) {
                          nodes {
                            id
                            project {
                              id
                              title
                              field(name: "Status") {
                                ... on ProjectV2SingleSelectField {
                                  id
                                  options { id name }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }`,
                  { owner, repo, num },
                );
                projectItems =
                  result?.repository?.issue?.projectItems?.nodes ?? [];
              } catch (err) {
                const msg = err.message ?? "";
                if (msg.includes("not authorized") || msg.includes("403")) {
                  console.log(
                    "Skipping Projects v2 update: token lacks project scope. " +
                      "Add a GH_TOKEN secret with 'project' read/write scope to enable this.",
                  );
                  break;
                }
                core.warning(
                  `Projects v2 query failed for issue #${num}: ${msg}`,
                );
                continue;
              }

              for (const item of projectItems) {
                const field = item.project?.field;
                if (!field?.options) continue;

                const option = field.options.find(
                  (o) => o.name.toLowerCase() === "in progress",
                );
                if (!option) {
                  console.log(
                    `Project "${item.project.title}" has no "In Progress" status option – skipping.`,
                  );
                  continue;
                }

                try {
                  await github.graphql(
                    `mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { singleSelectOptionId: $optionId }
                      }) {
                        projectV2Item { id }
                      }
                    }`,
                    {
                      projectId: item.project.id,
                      itemId: item.id,
                      fieldId: field.id,
                      optionId: option.id,
                    },
                  );
                  console.log(
                    `✓ Set project "${item.project.title}" status to "In Progress" for issue #${num}`,
                  );
                } catch (err) {
                  core.warning(
                    `Could not update project status for issue #${num}: ${err.message}`,
                  );
                }
              }
            }
