name: PR Template Enforcement

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  pull-requests: read

jobs:
  enforce-template:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body sections
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request?.body ?? "").trim();
            const requiredSections = [
              "## Product Outcome",
              "## User/Customer Impact",
              "## Scope Delivered",
              "## Out of Scope",
              "## Issue Link",
            ];

            const missing = requiredSections.filter((section) => !body.includes(section));
            if (missing.length > 0) {
              core.setFailed(
                [
                  "PR body is missing required product template sections:",
                  ...missing.map((item) => `- ${item}`),
                ].join("\n"),
              );
              return;
            }

            const unresolvedChecks = [
              {
                label: "Unfilled Product Outcome prompt",
                test: /Describe the product-level outcome this PR delivers\./,
              },
              {
                label: "Unfilled User/Customer Impact prompt",
                test: /Describe who benefits and how the experience or capability changes\./,
              },
              {
                label: "Unfilled Scope Delivered prompt",
                test: /List the product capabilities or behaviors now delivered\./,
              },
              {
                label: "Unfilled Out of Scope prompt",
                test: /List what is intentionally not included in this PR\./,
              },
              {
                label: "Unfilled Issue Link",
                test: /^Closes #\s*$/m,
              },
            ];
            const unresolved = unresolvedChecks
              .filter((item) => item.test.test(body))
              .map((item) => item.label);

            if (unresolved.length > 0) {
              core.setFailed(
                [
                  "PR body still contains unresolved template placeholders:",
                  ...unresolved.map((item) => `- ${item}`),
                ].join("\n"),
              );
            }
